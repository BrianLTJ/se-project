{% extends 'base.html' %}
{% block title %}{{ pagetitle }}{% endblock %}
{% block body %}
    <h2>{{ pagetitle }}</h2>

    <div id="group-add">
        <div>
            <label for="group-name">用户组名称</label>
            <input type="text" id="group-name" v-model="group.name">
        </div>
        <div>
            <div>权限描述（节点名）：
                <select name="" id="" v-model="permtoadd">
                    <option value="">(请选择)</option>
                    <option
                        is="perm-item"
                        v-for="item in permlist"
                        :value="item.id"
                        :name="item.name"
                        :codename="item.codename">
                    </option>
                </select>
                <button type="button" @click="add_to_list">添加权限</button>
            </div>
            <div>
                <perm
                    v-for="item in group.perms"
                    :name="item.name"
                    :codename="item.codename"
                    v-on:remove="group.perms.splice(index,1)"></perm>
            </div>
        </div>
    <div>
        {% if id > -1 %}
            <button type="button" @click="save_group">保存</button>
        {% else %}
            <button type="button" @click="add_group">添加</button>
        {% endif %}

    </div>
    </div>

    <script>
    //api
    var api_group_add="{% url 'api_admin_user:group_add' %}";
    var api_group_save="{% url 'api_admin_user:group_change' %}";
    var api_perm_list="{% url 'api_admin_user:permission_list' %}";
    var api_group_detail="{% url 'api_admin_user:group_detail' %}";
    //Initial vars
    {% if id > -1 %}
        var groupid={{ id }};
    {% else %}
        var groupid=-1;
    {% endif %}

    </script>
{% verbatim %}
    <script>
    Vue.component('perm-item',{
        template:'<option :value="id">{{ name }}({{ codename }})</option>',
        props: ['id','name','codename']
    });
    Vue.component('perm',{
        template: '<span>{{ name }}({{ codename }})<button type="button" v-on:click="$emit(\'remove\')">X</button></span>',
        props:['name','codename']
    })
    var groupadd = new Vue({
        el: "#group-add",
        data: {
            group:{
                id: groupid,
                name: "",
                perms:[]
            },
            permlist: [],
            permtoadd: ""
        },
        methods: {
            fetch_perm_list: function () {
                $.get({
                    url: api_perm_list,
                    success: function (data) {
                        if(data['result']=='ok'){
                            //  console.log(data);
                            groupadd.$data['permlist']=data['perms'];
                        }
                    }
                });
            },
            add_to_list: function () {
                perm_exist=false;
                perm_id=-1;
                for(var i=0;i<groupadd.$data['permlist'].length;i++){
                    if(groupadd.$data['permtoadd']==groupadd.$data['permlist'][i]['id']){
                        perm_id=i;
                        break;
                    }
                }
                for(var i=0;i<groupadd.$data['group']['perms'].length;i++){
                    if(groupadd.$data['group']['perms'][i]['id']==groupadd.$data['permtoadd']){
                        perm_exist=true;
                        break;
                    }
                }
                if(!perm_exist && perm_id>=0){
                    groupadd.$data['group']['perms'].push({'id':groupadd.$data['permlist'][perm_id]['id'],'name':groupadd.$data['permlist'][perm_id]['name'],'codename':groupadd.$data['permlist'][perm_id]['codename']});
                }
            },
            add_group: function () {
                $.post({
                    url: api_group_add,
                    data: JSON.stringify(groupadd.$data['group']),
                    success: function (data) {
                        console.log(data)
                    }
                })
            },
            save_group: function () {
                $.post({
                    url: api_group_save,
                    data: JSON.stringify(groupadd.$data['group']),
                    success: function (data) {
                        console.log(data);
                    }
                });
            },
            fetch_group_info: function () {
                $.post({
                    url:api_group_detail,
                    data: JSON.stringify({"id": groupid}),
                    success:function (data) {
                        console.log(data);
                        if(data['result']=='ok'){
                            groupadd.$data['group']=data['group'];
                        }
                    }
                })
            }
        }
    });
    groupadd.fetch_perm_list();
    if(groupid>-1){
        groupadd.fetch_group_info();
    }
    </script>
{% endverbatim %}

{% endblock %}