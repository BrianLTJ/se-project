{% extends 'base.html' %}
{% block title %}{{ pagetitle }}{% endblock %}
{% block body %}

<div id="useradd">
    <div><label for="username">用户名</label><input type="text" id="username" v-model="user.username"></div>
    {% if id > -1 %}
        <p>更改密码</p>
    {% else %}
    {# New User can set password, existed user cant change password from here #}
    <div><label for="password">密码</label><input type="password" id="password" v-model="user.password"></div>
    {% endif %}
    <div>
        <p>
            添加用户组：
            <select name="" id="" v-model="grouptoadd">
                <option value="">(请选择)</option>
                <option is="group-opt" v-for="i in grouplist" :value="i.id" :name="i.name"></option>
            </select>
            <button type="button" @click="push_to_list">加入用户组</button>
        </p>
        <p>
            <group-list
                v-for="(i,index) in user.groups"
                :text="i.name"
                @remove="user.groups.splice(index,1)"></group-list>
        </p>

    </div>
    <div>
        <p>
            设置借书权限组：
            <select name="" id="" v-model="user.borrowright">
                <option value="">(请选择)</option>
                <option
                    is="borrowright-opt"
                    v-for="br in borrowrightlist"
                    :id="br.id"
                    :name="br.name"
                    :day="br.day"
                    :booknum="br.booknum"></option>
            </select>
        </p>
    </div>
    <div>
        {% if id > -1 %}
            <button type="button" @click="edituser">保存更改</button>
            <button type="button" @click="deleteuser">删除用户</button>
        {% else %}
            <button type="button" @click="adduser">添加用户</button>
        {% endif %}

    </div>
</div>
    <script>
    // api urls
    var api_adduser="{% url 'api_admin_user:user_add' %}";
    var api_grouplist="{% url 'api_admin_user:group_list' %}";
    var api_user_edit="{% url 'api_admin_user:user_edit' %}";
    var api_user_delete="{% url 'api_admin_user:user_delete' %}";
    var api_user_detail="{% url 'api_admin_user:user_detail' %}";

    {% if id > -1 %}
        var userid={{ id }};
    {% else %}
        var userid=-1;
    {% endif %}
    </script>
    {% verbatim %}
    <script>
    Vue.component('group-opt',{
        template:"<option :value='id'>{{ name }}</option>",
        props: ['id','name']
    });
    Vue.component('group-list',{
        template:'<span>{{ text }} <button type="button" @click="$emit(\'remove\')">X</button></span>',
        props: ['text']
    });
    Vue.component('borrowright-opt',{
        template: '<option :value="id">{{ name }}，最多可借{{ booknum }}本，每本可借{{ day }}天</option>',
        props: ['id','name','booknum','day']
    });
    var useradd = new Vue({
        el: "#useradd",
        data: {
            user:{
                username:"",
                password:"",
                groups:[],
                borrowright: ""
            },
            grouplist:[],
            borrowrightlist: [],
            grouptoadd: ''
        },
        methods: {
            adduser: function () {
                $.post({
                    url: api_adduser,
                    data: JSON.stringify(useradd.$data['user']),
                    success: function (data) {
                        console.log(data);
                    }
                });
            },
            edituser: function () {
                $.post({
                    url: api_user_edit,
                    data: JSON.stringify(useradd.$data['user']),
                    success:function (data) {
                        console.log(data);
                    }
                });
            },
            deleteuser: function () {
                $.post({
                    url: api_user_delete,
                    data: JSON.stringify({"id": useradd.$data['user']['id']}),
                    success: function (data) {
                        console.log(data);
                    }
                });
            },
            fetch_user_detail: function () {
                $.post({
                    url: api_user_detail,
                    data: JSON.stringify({"id": userid}),
                    success: function (data) {
                        if(data['result']=='ok'){
                            useradd.$data['user']=data['user'];
                        }
                    }
                });
            },
            fetch_group_list: function () {
                $.get({
                    url: api_grouplist,
                    success: function (data) {
                        console.log(data);
                        if(data['result']=='ok'){
                            useradd.$data['grouplist']=data['groups'];
                        }
                    }
                });
            },
            fetch_borrowright_list: function () {

            },
            push_to_list: function () {
                group_exist=false; // group exists in user group
                group_index_in_list=-1;
                // Try to find the group in grouplist
                for(var i=0;i<useradd.$data['grouplist'].length;i++){
                    if(useradd.$data['grouptoadd']==useradd.$data['grouplist'][i]['id']){
                        group_index_in_list=i;
                        break;
                    }
                }
                for(var i=0;i<useradd.$data['user']['groups'].length;i++){
                    if(useradd.$data['user']['groups'][i]['id']==useradd.$data['grouptoadd']){
                        group_exist=true;
                        break;
                    }
                }
                if(!group_exist&& group_index_in_list>-1){
                    useradd.$data['user']['groups'].push({'id': useradd.$data['grouptoadd'], 'name':useradd.$data['grouplist'][group_index_in_list]['name']});
                }
            }
        }
    });
    useradd.fetch_group_list();
    if(userid>-1){
        useradd.fetch_user_detail();
    }
    </script>
    {% endverbatim %}

{% endblock %}